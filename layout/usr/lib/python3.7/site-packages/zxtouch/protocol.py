from dataclasses import dataclass, field
from typing import Any, Dict, Optional


@dataclass
class AttachRequest:
    client_id: str
    lease_ttl_ms: int
    capabilities: Dict[str, Any] = field(default_factory=dict)

    def to_dict(self) -> Dict[str, Any]:
        return {
            "type": "ATTACH_REQ",
            "client_id": self.client_id,
            "lease_ttl_ms": self.lease_ttl_ms,
            "capabilities": self.capabilities,
        }


@dataclass
class AttachAck:
    lease_id: str
    lease_expiry_ts: str
    heartbeat_interval_ms: int
    plan_state: Optional[Dict[str, Any]] = None

    def to_dict(self) -> Dict[str, Any]:
        data = {
            "type": "ATTACH_ACK",
            "lease_id": self.lease_id,
            "lease_expiry_ts": self.lease_expiry_ts,
            "heartbeat_interval_ms": self.heartbeat_interval_ms,
        }
        if self.plan_state is not None:
            data["plan_state"] = self.plan_state
        return data


@dataclass
class Heartbeat:
    lease_id: str
    seq: int

    def to_dict(self) -> Dict[str, Any]:
        return {"type": "HEARTBEAT", "lease_id": self.lease_id, "seq": self.seq}


@dataclass
class HeartbeatAck:
    lease_id: str
    server_ts: str
    plan_state: Optional[Dict[str, Any]] = None

    def to_dict(self) -> Dict[str, Any]:
        data = {"type": "HEARTBEAT_ACK", "lease_id": self.lease_id, "server_ts": self.server_ts}
        if self.plan_state is not None:
            data["plan_state"] = self.plan_state
        return data


@dataclass
class Detach:
    lease_id: str
    reason: str = ""

    def to_dict(self) -> Dict[str, Any]:
        return {"type": "DETACH", "lease_id": self.lease_id, "reason": self.reason}


@dataclass
class ReattachRequest:
    client_id: str
    lease_id: str
    resume_token: Optional[str] = None

    def to_dict(self) -> Dict[str, Any]:
        data = {"type": "REATTACH_REQ", "client_id": self.client_id, "lease_id": self.lease_id}
        if self.resume_token is not None:
            data["resume_token"] = self.resume_token
        return data


@dataclass
class ReattachAck:
    lease_id: str
    lease_expiry_ts: str
    plan_snapshot: Dict[str, Any]

    def to_dict(self) -> Dict[str, Any]:
        return {
            "type": "REATTACH_ACK",
            "lease_id": self.lease_id,
            "lease_expiry_ts": self.lease_expiry_ts,
            "plan_snapshot": self.plan_snapshot,
        }


@dataclass
class ProgressRequest:
    plan_id: str

    def to_dict(self) -> Dict[str, Any]:
        return {"type": "GET_PROGRESS", "plan_id": self.plan_id}


@dataclass
class ProgressResponse:
    plan_id: str
    current_step_id: Optional[str]
    step_status: Dict[str, str]
    budgets_used: Dict[str, int]
    started_at: str
    updated_at: str

    def to_dict(self) -> Dict[str, Any]:
        return {
            "type": "PROGRESS",
            "plan_id": self.plan_id,
            "current_step_id": self.current_step_id,
            "step_status": self.step_status,
            "budgets_used": self.budgets_used,
            "started_at": self.started_at,
            "updated_at": self.updated_at,
        }


@dataclass
class LogsRequest:
    plan_id: str
    cursor: Optional[str] = None

    def to_dict(self) -> Dict[str, Any]:
        data = {"type": "GET_LOGS", "plan_id": self.plan_id}
        if self.cursor is not None:
            data["cursor"] = self.cursor
        return data


@dataclass
class LogsResponse:
    plan_id: str
    entries: Dict[str, Any]
    next_cursor: Optional[str] = None

    def to_dict(self) -> Dict[str, Any]:
        data = {"type": "LOGS", "plan_id": self.plan_id, "entries": self.entries}
        if self.next_cursor is not None:
            data["next_cursor"] = self.next_cursor
        return data


@dataclass
class ScreenshotRequest:
    plan_id: str
    rect: Optional[Dict[str, int]] = None
    scale: Optional[float] = None
    format: str = "jpg"

    def to_dict(self) -> Dict[str, Any]:
        data = {"type": "GET_SCREENSHOT", "plan_id": self.plan_id, "format": self.format}
        if self.rect is not None:
            data["rect"] = self.rect
        if self.scale is not None:
            data["scale"] = self.scale
        return data


@dataclass
class ScreenshotResponseHeader:
    plan_id: str
    format: str
    width: int
    height: int
    bytes_len: int

    def to_dict(self) -> Dict[str, Any]:
        return {
            "type": "SCREENSHOT",
            "plan_id": self.plan_id,
            "format": self.format,
            "width": self.width,
            "height": self.height,
            "bytes_len": self.bytes_len,
        }
