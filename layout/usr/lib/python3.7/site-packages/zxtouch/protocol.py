from dataclasses import dataclass, field
from typing import Any, Dict, Optional


@dataclass
class AttachRequest:
    client_id: str
    lease_ttl_ms: int
    capabilities: Dict[str, Any] = field(default_factory=dict)

    def to_dict(self) -> Dict[str, Any]:
        return {
            "type": "ATTACH_REQ",
            "client_id": self.client_id,
            "lease_ttl_ms": self.lease_ttl_ms,
            "capabilities": self.capabilities,
        }


@dataclass
class Heartbeat:
    lease_id: str
    seq: int

    def to_dict(self) -> Dict[str, Any]:
        return {"type": "HEARTBEAT", "lease_id": self.lease_id, "seq": self.seq}


@dataclass
class Detach:
    lease_id: str
    reason: str = ""

    def to_dict(self) -> Dict[str, Any]:
        return {"type": "DETACH", "lease_id": self.lease_id, "reason": self.reason}


@dataclass
class ReattachRequest:
    client_id: str
    lease_id: str
    resume_token: Optional[str] = None

    def to_dict(self) -> Dict[str, Any]:
        data = {"type": "REATTACH_REQ", "client_id": self.client_id, "lease_id": self.lease_id}
        if self.resume_token is not None:
            data["resume_token"] = self.resume_token
        return data


@dataclass
class ProgressRequest:
    plan_id: str

    def to_dict(self) -> Dict[str, Any]:
        return {"type": "GET_PROGRESS", "plan_id": self.plan_id}


@dataclass
class LogsRequest:
    plan_id: str
    cursor: Optional[str] = None

    def to_dict(self) -> Dict[str, Any]:
        data = {"type": "GET_LOGS", "plan_id": self.plan_id}
        if self.cursor is not None:
            data["cursor"] = self.cursor
        return data


@dataclass
class ScreenshotRequest:
    plan_id: str
    rect: Optional[Dict[str, int]] = None
    scale: Optional[float] = None
    format: str = "jpg"

    def to_dict(self) -> Dict[str, Any]:
        data = {"type": "GET_SCREENSHOT", "plan_id": self.plan_id, "format": self.format}
        if self.rect is not None:
            data["rect"] = self.rect
        if self.scale is not None:
            data["scale"] = self.scale
        return data
