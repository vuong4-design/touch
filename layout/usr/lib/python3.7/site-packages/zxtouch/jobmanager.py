import json
from dataclasses import dataclass, field
from pathlib import Path
from typing import Any, Dict, Optional

from .plan import Plan


@dataclass
class JobState:
    plan: Optional[Plan] = None
    current_step_id: Optional[str] = None
    step_status: Dict[str, str] = field(default_factory=dict)
    last_seq: Dict[str, Dict[str, int]] = field(default_factory=dict)
    retry_counters: Dict[str, int] = field(default_factory=dict)
    lease_info: Dict[str, Any] = field(default_factory=dict)
    budgets_used: Dict[str, int] = field(default_factory=dict)
    timestamps: Dict[str, str] = field(default_factory=dict)

    def to_dict(self) -> Dict[str, Any]:
        return {
            "plan": self.plan.to_dict() if self.plan else None,
            "current_step_id": self.current_step_id,
            "step_status": self.step_status,
            "last_seq": self.last_seq,
            "retry_counters": self.retry_counters,
            "lease_info": self.lease_info,
            "budgets_used": self.budgets_used,
            "timestamps": self.timestamps,
        }

    @classmethod
    def from_dict(cls, data: Dict[str, Any]) -> "JobState":
        plan_data = data.get("plan")
        return cls(
            plan=Plan.from_dict(plan_data) if plan_data else None,
            current_step_id=data.get("current_step_id"),
            step_status=dict(data.get("step_status", {})),
            last_seq=dict(data.get("last_seq", {})),
            retry_counters=dict(data.get("retry_counters", {})),
            lease_info=dict(data.get("lease_info", {})),
            budgets_used=dict(data.get("budgets_used", {})),
            timestamps=dict(data.get("timestamps", {})),
        )


class JobManager:
    def __init__(self, state_path: str) -> None:
        self.state_path = Path(state_path)
        self.state = JobState()

    def load_state(self) -> JobState:
        if not self.state_path.exists():
            return self.state
        data = json.loads(self.state_path.read_text(encoding="utf-8"))
        self.state = JobState.from_dict(data)
        return self.state

    def checkpoint(self) -> None:
        self.state_path.parent.mkdir(parents=True, exist_ok=True)
        self.state_path.write_text(json.dumps(self.state.to_dict(), indent=2), encoding="utf-8")

    def restore_plan(self, plan: Plan) -> None:
        self.state.plan = plan
        if plan.steps:
            self.state.current_step_id = plan.steps[0].step_id
        self.checkpoint()

