from dataclasses import dataclass, field
from datetime import datetime
from typing import Any, Dict, List, Optional


@dataclass
class LogRecord:
    level: str
    message: str
    timestamp: str = field(default_factory=lambda: datetime.utcnow().isoformat())
    context: Dict[str, Any] = field(default_factory=dict)

    def to_dict(self) -> Dict[str, Any]:
        return {
            "level": self.level,
            "message": self.message,
            "timestamp": self.timestamp,
            "context": self.context,
        }


class LoggingStore:
    def __init__(self, max_entries: int = 1000) -> None:
        self._max_entries = max_entries
        self._entries: List[LogRecord] = []

    def append(self, record: LogRecord) -> None:
        self._entries.append(record)
        if len(self._entries) > self._max_entries:
            self._entries = self._entries[-self._max_entries :]

    def log(self, level: str, message: str, context: Optional[Dict[str, Any]] = None) -> LogRecord:
        record = LogRecord(level=level, message=message, context=context or {})
        self.append(record)
        return record

    def list(self) -> List[Dict[str, Any]]:
        return [entry.to_dict() for entry in self._entries]
