from dataclasses import dataclass, field
from typing import Any, Dict, List, Optional, Tuple


@dataclass
class LogEntry:
    cursor: str
    event_type: str
    step_id: Optional[str] = None
    timestamp: str = ""
    reason: Optional[str] = None
    metrics: Dict[str, Any] = field(default_factory=dict)

    def to_dict(self) -> Dict[str, Any]:
        data = {
            "cursor": self.cursor,
            "event_type": self.event_type,
            "timestamp": self.timestamp,
            "metrics": self.metrics,
        }
        if self.step_id is not None:
            data["step_id"] = self.step_id
        if self.reason is not None:
            data["reason"] = self.reason
        return data


@dataclass
class ProgressSnapshot:
    plan_id: str
    current_step_id: Optional[str]
    step_status: Dict[str, str]
    budgets_used: Dict[str, int]
    started_at: str
    updated_at: str

    def to_dict(self) -> Dict[str, Any]:
        return {
            "plan_id": self.plan_id,
            "current_step_id": self.current_step_id,
            "step_status": self.step_status,
            "budgets_used": self.budgets_used,
            "started_at": self.started_at,
            "updated_at": self.updated_at,
        }


class TelemetryStore:
    def __init__(self) -> None:
        self._entries: List[LogEntry] = []
        self._next_cursor = 1

    def append(self, entry: LogEntry) -> None:
        self._entries.append(entry)

    def add_event(
        self,
        event_type: str,
        step_id: Optional[str] = None,
        timestamp: str = "",
        reason: Optional[str] = None,
        metrics: Optional[Dict[str, Any]] = None,
    ) -> LogEntry:
        cursor = f"log_{self._next_cursor:06d}"
        self._next_cursor += 1
        entry = LogEntry(
            cursor=cursor,
            event_type=event_type,
            step_id=step_id,
            timestamp=timestamp,
            reason=reason,
            metrics=metrics or {},
        )
        self.append(entry)
        return entry

    def get_logs(self, cursor: Optional[str]) -> Dict[str, Any]:
        start_index = 0
        if cursor:
            for idx, entry in enumerate(self._entries):
                if entry.cursor == cursor:
                    start_index = idx + 1
                    break
        entries = [entry.to_dict() for entry in self._entries[start_index:]]
        next_cursor = self._entries[-1].cursor if self._entries else cursor
        return {"entries": entries, "next_cursor": next_cursor}

    def get_logs_with_plan(self, plan_id: str, cursor: Optional[str]) -> Dict[str, Any]:
        data = self.get_logs(cursor)
        return {"plan_id": plan_id, "entries": data["entries"], "next_cursor": data["next_cursor"]}
