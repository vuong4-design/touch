from dataclasses import dataclass, field
from typing import Any, Dict, List, Optional


@dataclass
class RetryPolicy:
    max: int = 0
    backoff_ms: int = 0

    def to_dict(self) -> Dict[str, Any]:
        return {"max": self.max, "backoff_ms": self.backoff_ms}


@dataclass
class OnFail:
    action: str = "abort"
    target: Optional[str] = None

    def to_dict(self) -> Dict[str, Any]:
        data = {"action": self.action}
        if self.target is not None:
            data["target"] = self.target
        return data


@dataclass
class StepBudget:
    time_ms: int = 0

    def to_dict(self) -> Dict[str, Any]:
        return {"time_ms": self.time_ms}


@dataclass
class PlanBudget:
    time_ms: int = 0
    touch_ops: int = 0
    retry_total: int = 0

    def to_dict(self) -> Dict[str, Any]:
        return {
            "time_ms": self.time_ms,
            "touch_ops": self.touch_ops,
            "retry_total": self.retry_total,
        }


@dataclass
class Guard:
    type: str
    params: Dict[str, Any] = field(default_factory=dict)

    def to_dict(self) -> Dict[str, Any]:
        return {"type": self.type, "params": self.params}


@dataclass
class Step:
    step_id: str
    type: str
    payload: Dict[str, Any] = field(default_factory=dict)
    guards: List[Guard] = field(default_factory=list)
    retry: RetryPolicy = field(default_factory=RetryPolicy)
    on_fail: OnFail = field(default_factory=OnFail)
    budget: StepBudget = field(default_factory=StepBudget)

    def to_dict(self) -> Dict[str, Any]:
        return {
            "step_id": self.step_id,
            "type": self.type,
            "payload": self.payload,
            "guards": [guard.to_dict() for guard in self.guards],
            "retry": self.retry.to_dict(),
            "on_fail": self.on_fail.to_dict(),
            "budget": self.budget.to_dict(),
        }


@dataclass
class Plan:
    plan_id: str
    plan_version: int = 1
    created_at: str = ""
    budgets: PlanBudget = field(default_factory=PlanBudget)
    steps: List[Step] = field(default_factory=list)
    on_fail: OnFail = field(default_factory=OnFail)

    def to_dict(self) -> Dict[str, Any]:
        return {
            "plan_id": self.plan_id,
            "plan_version": self.plan_version,
            "created_at": self.created_at,
            "budgets": self.budgets.to_dict(),
            "steps": [step.to_dict() for step in self.steps],
            "on_fail": self.on_fail.to_dict(),
        }

    def validate(self) -> None:
        if not self.plan_id:
            raise ValueError("plan_id is required")
        step_ids = {step.step_id for step in self.steps}
        if len(step_ids) != len(self.steps):
            raise ValueError("step_id must be unique within a plan")
        for step in self.steps:
            if not step.step_id:
                raise ValueError("step_id is required for every step")
            if not step.type:
                raise ValueError("step.type is required for every step")
