from dataclasses import dataclass
from typing import Dict, Optional, Tuple

from .protocol import ScreenshotRequest


@dataclass
class ScreenshotOptions:
    rect: Optional[Dict[str, int]] = None
    scale: Optional[float] = None
    format: str = "jpg"

    def to_request(self, plan_id: str) -> ScreenshotRequest:
        return ScreenshotRequest(plan_id=plan_id, rect=self.rect, scale=self.scale, format=self.format)


class ScreenshotEncoder:
    def __init__(self, max_bytes: int = 1024 * 1024) -> None:
        self.max_bytes = max_bytes

    def clamp_scale(self, scale: Optional[float]) -> float:
        if scale is None:
            return 0.5
        return max(0.1, min(1.0, scale))

    def should_downscale(self, byte_len: int) -> bool:
        return byte_len > self.max_bytes

    def build_header(self, format: str, width: int, height: int, bytes_len: int) -> Dict[str, int]:
        return {"format": format, "width": width, "height": height, "bytes_len": bytes_len}
