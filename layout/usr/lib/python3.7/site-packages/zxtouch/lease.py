from dataclasses import dataclass
from datetime import datetime, timedelta
from typing import Optional


@dataclass
class LeaseInfo:
    lease_id: str
    client_id: str
    lease_expiry_ts: datetime
    heartbeat_interval_ms: int

    def expired(self, now: Optional[datetime] = None) -> bool:
        now = now or datetime.utcnow()
        return now >= self.lease_expiry_ts

    def extend(self, ttl_ms: int) -> None:
        self.lease_expiry_ts = datetime.utcnow() + timedelta(milliseconds=ttl_ms)


class LeaseManager:
    def __init__(self) -> None:
        self._lease: Optional[LeaseInfo] = None

    @property
    def lease(self) -> Optional[LeaseInfo]:
        return self._lease

    def attach(self, lease_id: str, client_id: str, ttl_ms: int, heartbeat_interval_ms: int) -> LeaseInfo:
        lease = LeaseInfo(
            lease_id=lease_id,
            client_id=client_id,
            lease_expiry_ts=datetime.utcnow() + timedelta(milliseconds=ttl_ms),
            heartbeat_interval_ms=heartbeat_interval_ms,
        )
        self._lease = lease
        return lease

    def heartbeat(self, lease_id: str, ttl_ms: int) -> bool:
        if not self._lease or self._lease.lease_id != lease_id:
            return False
        self._lease.extend(ttl_ms)
        return True

    def detach(self, lease_id: str) -> bool:
        if not self._lease or self._lease.lease_id != lease_id:
            return False
        self._lease = None
        return True

    def check_expired(self) -> bool:
        if not self._lease:
            return False
        if self._lease.expired():
            self._lease = None
            return True
        return False
